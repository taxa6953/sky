<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نوار پایین سه‌تایی — رفع باگ</title>
  <style>
    :root{
      --bg: #ffffff;
      --pill-bg: rgba(0,0,0,0.05);
      --pill-shadow: 0 10px 30px rgba(0,0,0,0.12);
      --accent: #2187c9;
      --muted: #333;
      --pill-radius: 44px;
      --pill-padding: 8px;
      --width-max: 760px;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family: "Helvetica Neue", Arial, sans-serif;
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
    }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:32px 16px 120px;
      box-sizing:border-box;
    }

    .pages{
      width:100%;
      max-width:var(--width-max);
      height:420px;
      background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
      border-radius:14px;
      overflow:hidden;
      position:relative;
      display:flex; /* pages are horizontally aligned */
      transition: transform .28s cubic-bezier(.2,.9,.2,1);
    }
    .page{
      min-width:100%;
      padding:24px;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
    }

    .bottom-wrap{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      width:calc(100% - 40px);
      max-width:calc(var(--width-max) + 64px);
      z-index:60;
      pointer-events:none;
    }

    .pill{
      pointer-events:auto;
      margin:0 auto;
      background:var(--pill-bg);
      border-radius:var(--pill-radius);
      box-shadow:var(--pill-shadow);
      padding:var(--pill-padding);
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:relative;
      height:82px;
      overflow:visible;
    }

    .nav{
      display:flex;
      gap:8px;
      width:100%;
      align-items:center;
      justify-content:space-between;
      padding:6px 12px;
      box-sizing:border-box;
      position:relative; /* مرجع محاسبه حباب */
    }

    .nav button{
      all:unset;
      cursor:pointer;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex:1 1 0;
      padding:8px 14px;
      border-radius:32px;
      position:relative;
      z-index:3; /* بالاتر از حباب */
      text-align:center;
      color:var(--muted);
      user-select:none;
      transition: color .22s ease;
    }

    .nav button:focus{
      outline:3px solid rgba(33,135,201,0.16);
      outline-offset:4px;
      border-radius:28px;
    }

    .label{
      font-size:13px;
      line-height:1;
      display:block;
      direction:ltr;
      color:var(--muted);
    }

    /* حباب سفید داخلی */
    .active-bubble{
      position:absolute;
      top:6px;
      bottom:6px;
      left:0;
      width:0;
      border-radius:32px;
      background:linear-gradient(180deg,#fff,#fbfbfb);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.6);
      transition: left .28s cubic-bezier(.2,.9,.2,1), width .28s cubic-bezier(.2,.9,.2,1);
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      border:2px solid rgba(0,0,0,0.03);
    }

    /* قاب رنگی ریز دور آیکن (آبی) که هم‌زمان حرکت کند */
    .active-outline{
      position:absolute;
      top:10px;
      height:56px;
      width:56px;
      border-radius:16px;
      box-sizing:border-box;
      border:2px solid rgba(33,135,201,0.12);
      transition: left .28s cubic-bezier(.2,.9,.2,1), width .28s cubic-bezier(.2,.9,.2,1), height .28s cubic-bezier(.2,.9,.2,1);
      z-index:2;
      pointer-events:none;
      background:transparent;
    }

    .bubble-inner{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:0 6px;
      border-radius:22px;
      pointer-events:none;
    }

    .icon{
      width:28px;
      height:28px;
      display:inline-block;
      flex-shrink:0;
    }

    .muted{
      font-size:12px;
      opacity:.95;
      color:var(--muted);
    }

    .nav button.active .muted,
    .nav button.active .label{
      color:var(--accent);
      font-weight:600;
    }
    .nav button.active svg { color:var(--accent); filter:none; }

    @media (max-width:420px){
      .label{ display:none; }
      .pill{ height:72px; }
      .active-outline{ height:50px; width:50px; top:12px; }
      .icon{ width:22px; height:22px; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="pages" id="pages" aria-live="polite">
      <section class="page" data-index="0" id="page-0">
        <div style="text-align:center;">
          <h2>اطلاعات کاربر</h2>
          <p>نام، شماره، نقش و خلاصه‌ای از اطلاعات کاربر در این بخش نمایش داده می‌شود.</p>
        </div>
      </section>
      <section class="page" data-index="1" id="page-1">
        <div style="text-align:center;">
          <h2>اخبار</h2>
          <p>لیستی از آخرین خبرها یا اعلان‌ها در این بخش قرار می‌گیرد.</p>
        </div>
      </section>
      <section class="page" data-index="2" id="page-2">
        <div style="text-align:center;">
          <h2>لیست</h2>
          <p>فهرستی از آیتم‌ها، وظایف یا موارد مرتبط نمایش داده می‌شود.</p>
        </div>
      </section>
    </div>
  </div>

  <div class="bottom-wrap" role="navigation" aria-label="نوار ناوبری پایین">
    <div class="pill" id="pill" style="max-width:var(--width-max);">
      <div class="nav" id="nav" role="tablist" aria-orientation="horizontal">
        <button role="tab" aria-selected="false" aria-controls="page-0" data-index="0" tabindex="0">
          <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.6"/>
            <path d="M4 20c0-3.3 2.7-6 6-6h4c3.3 0 6 2.7 6 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <span class="label muted">کاربر</span>
        </button>

        <button role="tab" aria-selected="false" aria-controls="page-1" data-index="1" tabindex="0">
          <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.6"/>
            <path d="M7 9h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M7 13h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <span class="label muted">اخبار</span>
        </button>

        <button role="tab" aria-selected="true" aria-controls="page-2" data-index="2" tabindex="0" class="active">
          <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M8 6h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M8 12h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M8 18h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <circle cx="4.5" cy="6" r="1" fill="currentColor"/>
            <circle cx="4.5" cy="12" r="1" fill="currentColor"/>
            <circle cx="4.5" cy="18" r="1" fill="currentColor"/>
          </svg>
          <span class="label muted">لیست</span>
        </button>

        <div class="active-bubble" id="activeBubble" aria-hidden="true">
          <div class="bubble-inner" id="bubbleInner">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M8 6h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M8 12h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M8 18h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </div>
        </div>

        <div class="active-outline" id="activeOutline" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const nav = document.getElementById('nav');
      const buttons = Array.from(nav.querySelectorAll('button'));
      const bubble = document.getElementById('activeBubble');
      const outline = document.getElementById('activeOutline');
      const pages = document.getElementById('pages');
      const pageEls = Array.from(document.querySelectorAll('.page'));
      let activeIndex = 2; // پیش‌فرض: لیست

      // اصلاح‌شده: استفاده از getBoundingClientRect نسبت به nav برای در نظر گرفتن gap/padding
      function updateBubble(toIndex, animate = true){
        const btn = buttons[toIndex];
        if(!btn) return;

        // محاسبهٔ دقیق نسبت به nav
        const navRect = nav.getBoundingClientRect();
        const btnRect = btn.getBoundingClientRect();

        const left = btnRect.left - navRect.left;
        const width = btnRect.width;

        if(!animate){
          bubble.style.transition = 'none';
          outline.style.transition = 'none';
        } else {
          bubble.style.transition = '';
          outline.style.transition = '';
        }

        const bubblePadding = 8; // فاصلهٔ داخلی کوچک
        bubble.style.left = (left + bubblePadding) + 'px';
        bubble.style.width = Math.max(56, width - bubblePadding*2) + 'px';

        const outlineSize = Math.min(64, width + 8);
        const outlineLeft = left + (width - outlineSize)/2;
        outline.style.left = outlineLeft + 'px';
        outline.style.width = outlineSize + 'px';
        outline.style.height = outlineSize + 'px';

        buttons.forEach((b,i)=>{
          b.classList.toggle('active', i===toIndex);
          b.setAttribute('aria-selected', String(i===toIndex));
          b.tabIndex = i===toIndex ? 0 : -1;
        });

        // هم‌رنگ کردن آیکن درون حباب با رنگ آیکنِ دکمه فعال
        const activeSvg = buttons[toIndex].querySelector('svg');
        const bubbleSvg = bubble.querySelector('svg');
        if(activeSvg && bubbleSvg){
          const computed = window.getComputedStyle(buttons[toIndex]).color;
          bubbleSvg.style.color = computed;
        }
      }

      function showPage(index){
        activeIndex = index;
        pages.style.transform = `translateX(${ - index * 100 }%)`;
        pageEls.forEach((p,i)=>{
          p.setAttribute('aria-hidden', String(i!==index));
        });
      }

      buttons.forEach((btn, i) => {
        btn.addEventListener('click', () => {
          updateBubble(i);
          showPage(i);
        });
      });

      function init(){
        // مقداردهی اولیه بدون انیمیشن برای جلوگیری از پرش
        updateBubble(activeIndex, false);
        showPage(activeIndex);
        // پس از لحظه‌ای، انیمیشن‌ها را فعال کن
        setTimeout(()=> {
          bubble.style.transition = '';
          outline.style.transition = '';
        }, 50);
      }
      window.addEventListener('load', init);
      window.addEventListener('resize', ()=> updateBubble(activeIndex, false));

      // پشتیبانی کلیدی
      window.addEventListener('keydown', (e)=>{
        if(['ArrowLeft','ArrowRight'].includes(e.key)){
          e.preventDefault();
        }
        if(e.key === 'ArrowLeft'){
          const next = Math.max(0, activeIndex - 1);
          updateBubble(next);
          showPage(next);
        } else if(e.key === 'ArrowRight'){
          const next = Math.min(buttons.length - 1, activeIndex + 1);
          updateBubble(next);
          showPage(next);
        }
      });

      // سوایپ لمسی
      let startX = null;
      pages.addEventListener('touchstart', (ev) => {
        startX = ev.touches[0].clientX;
      }, {passive:true});
      pages.addEventListener('touchend', (ev) => {
        if(startX === null) return;
        const endX = ev.changedTouches[0].clientX;
        const dx = endX - startX;
        if(Math.abs(dx) > 40){
          if(dx < 0){
            const next = Math.min(buttons.length - 1, activeIndex + 1);
            updateBubble(next);
            showPage(next);
          } else {
            const next = Math.max(0, activeIndex - 1);
            updateBubble(next);
            showPage(next);
          }
        }
        startX = null;
      }, {passive:true});

    })();
  </script>
</body>
</html>
